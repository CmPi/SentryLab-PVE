#
# @file sentrylab-witty.yaml
# @author CmPi <cmpi@webe.fr>
# @repo https://github.com/CmPi/SentryLab-PVE
# @brief Interface visuelle sécurisée pour module Witty Cloud
# @notes Utilise un fichier secrets.yaml pour la sécurité des identifiants
#

substitutions:
  # --- CONFIGURATION À ADAPTER ---
  device_id: "witty-monitor-01"      # ID unique de votre ESP
  nas_hostname: "albusnexus"         # Nom d'hôte défini dans PVE
  # -------------------------------

esphome:
  name: ${device_id}
  friendly_name: "SentryLab Monitor"

esp8266:
  board: esp12e

# --- CONNECTIVITÉ ET SÉCURITÉ ---
# Ces valeurs doivent être définies dans votre fichier secrets.yaml
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  
  # Optionnel : IP Statique conseillée pour la réactivité
  # manual_ip:
  #   static_ip: 192.168.x.x
  #   gateway: 192.168.x.x
  #   subnet: 255.255.255.0

# Activation de l'API pour la communication avec Home Assistant
api:
  encryption:
    key: !secret api_encryption_key

# Indispensable pour mettre à jour sans démonter le module !
ota:
  - platform: esphome
    password: !secret ota_password

# --- RÉCUPÉRATION DES DONNÉES DEPUIS HOME ASSISTANT ---
sensor:
  - platform: homeassistant
    id: nas_cpu_temp
    entity_id: sensor.${nas_hostname}_cpu_temp
    on_value:
      then:
        - script.execute:
            id: update_status_led
            temp_val: !lambda "return x;"

  # LDR (Luminosité) pour éviter d'éblouir la nuit
  - platform: adc
    id: ambient_light
    pin: A0
    update_interval: 60s
    filters:
      - multiply: 100

text_sensor:
  - platform: homeassistant
    id: zfs_status
    entity_id: sensor.${nas_hostname}_zfs_rpool_status
    on_value:
      then:
        - script.execute: check_nas_alarm

# --- CONTRÔLE DE LA LED RGB (Sorties PWM du Witty) ---
output:
  - platform: esp8266_pwm
    id: out_red
    pin: GPIO15
  - platform: esp8266_pwm
    id: out_green
    pin: GPIO12
  - platform: esp8266_pwm
    id: out_blue
    pin: GPIO13

light:
  - platform: rgb
    name: "Statut Visuel NAS"
    id: led_status
    red: out_red
    green: out_green
    blue: out_blue
    effects:
      - strobe:
          name: "Alarm"
          colors:
            - state: true
              red: 1.0; green: 0.0; blue: 0.0; duration: 300ms
            - state: true
              red: 0.0; green: 0.0; blue: 1.0; duration: 300ms

# --- LOGIQUE DE NOTIFICATION ---
script:
  - id: check_nas_alarm
    then:
      - if:
          condition:
            lambda: 'return id(zfs_status).state != "ONLINE";'
          then:
            - light.turn_on: {id: led_status, effect: "Alarm"}
          else:
            - light.turn_off: led_status
            - script.execute:
                id: update_status_led
                temp_val: !lambda "return id(nas_cpu_temp).state;"

  - id: update_status_led
    parameters:
      temp_val: float
    then:
      - lambda: |-
          if (id(led_status).get_effect_name() == "Alarm") return;
          
          float brightness = (id(ambient_light).state < 10.0) ? 0.05 : 0.3;
          float r=0, g=0, b=0;

          if (temp_val < 35.0) { 
            id(led_status).turn_off().perform(); 
            return; 
          } else if (temp_val < 45.0) {
            g = 1.0; // Vert
          } else if (temp_val < 60.0) {
            r = 1.0; g = 0.5; // Orange
          } else {
            r = 1.0; // Rouge
          }
          
          auto call = id(led_status).turn_on();
          call.set_rgb(r, g, b);
          call.set_brightness(brightness);
          call.perform();

# --- DIAGNOSTIC ---
binary_sensor:
  - platform: status
    name: "Sentry Monitor Status"